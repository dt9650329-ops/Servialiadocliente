<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>Plataforma de Domicilios - Cliente</title>
  <!-- Leaflet CSS para el mapa -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  
  <style>
    /* ------------------- COLORES BASE (Inspirados en Servi Aliados Logo) ------------------- */
    :root {
        --color-primary: #FFD700;
        --color-secondary: #000000;
        --color-background: #1a1a1a;
        --color-card: #333333;
        --color-text-light: #f0f0f0;
        --color-text-dark: #cccccc;
        --color-chat-user: #555555;
        --color-chat-user-text: #f0f0f0;
        --color-success: #28a745;
        --color-date-separator: #666; 
        --color-link: #4A9EFF;
    }
    
    /* ------------------- ESTILOS GENERALES ------------------- */
    * {box-sizing: border-box; 
        font-family: Arial, sans-serif; 
        margin: 0;
        padding: 0;
    }
    
    html, body { 
        width: 100%;
        height: 100%;
        overflow-x: hidden;
    }
    
    body { 
        background: linear-gradient(135deg, var(--color-background), var(--color-secondary)); 
        display: flex; 
        align-items: flex-start; 
        justify-content: center; 
        min-height: 100vh; 
        margin: 0; 
        padding: 0;
    }
    
    .container { 
        background: var(--color-card); 
        border-radius: 0;
        box-shadow: none;
        padding: 20px; 
        width: 90%; 
        max-width: 90%;
        min-height: 90vh;
        text-align: center; 
        color: var(--color-text-light); 
    }
    h2, h3 { color: var(--color-primary); }
    
    button { 
        width: 100%; 
        padding: 12px; 
        margin-top: 10px; 
        border: none; 
        border-radius: 8px; 
        background-color: var(--color-primary); 
        color: var(--color-secondary); 
        font-weight: bold;
        font-size: 16px; 
        cursor: pointer; 
        transition: background 0.3s; 
    }
    button:hover:not(:disabled) { background-color: #ffaa00; }
    button:disabled { background-color: #555; cursor: not-allowed; color: #999; }
    
    form { margin-top: 20px; text-align: left; }
    label { display: block; margin-top: 10px; font-weight: bold; color: var(--color-text-light);}
    input[type="text"], input[type="tel"], input[type="file"], input[type="email"], input[type="password"], select { 
        width: 100%; 
        padding: 10px; 
        border: 1px solid #555; 
        border-radius: 6px; 
        margin-top: 5px; 
        background-color: #444; 
        color: #FFFFFF; 
    }
    .back-btn { background-color: #444; color: var(--color-text-light); margin-top: 20px; }
    .back-btn:hover { background-color: #666; }

    #auth-status { 
        margin-top: 10px; 
        font-size: 14px; 
        color: var(--color-primary); 
        text-align: left; 
    }
    .auth-group { margin-bottom: 15px; }
    #vista-inicio button:nth-child(5) { 
        background-color: #555555; 
        color: var(--color-text-light);
    }
    #vista-inicio button:nth-child(5):hover { 
        background-color: #777777; 
    }
    
    /* ------------------- PERFIL Y CHAT ------------------- */
    .dato { text-align: left; margin: 8px 0; font-size: 14px; display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 5px; border-bottom: 1px dashed #555; }
    .dato strong { flex-shrink: 0; margin-right: 10px; color: var(--color-text-dark); }
    .dato span, .dato a { text-align: right; flex-grow: 1; color: var(--color-text-light); }
    .dato a { color: var(--color-primary); text-decoration: none; }
    .dato a:hover { text-decoration: underline; }

    .tabs-container { display: flex; margin-bottom: 20px; border-radius: 8px; overflow: hidden; gap: 2px; }
    .tab-button { flex: 1; padding: 10px; border: none; cursor: pointer; font-weight: bold; transition: background-color 0.2s; color: var(--color-secondary); font-size: 14px; white-space: nowrap;}
    .tab-button.active-tab { background-color: var(--color-primary); color: var(--color-secondary); }
    .tab-button:not(.active-tab) { background-color: #555; color: var(--color-text-light); }
    .tab-content { display: none; padding-top: 15px; }
    .tab-content.active-content { display: block; }
    /* Estilos del Chat */
    #chat-box { height: 400px; max-height: 60vh; overflow-y: auto; border: 1px solid #555; border-radius: 10px; padding: 10px; background: #222; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; }
    .mensaje { padding: 8px 12px; border-radius: 12px; margin: 8px 0; max-width: 80%; word-wrap: break-word; position: relative; display: flex; flex-direction: column;}
    
    .usuario { 
        background-color: var(--color-chat-user); 
        color: var(--color-chat-user-text); 
        align-self: flex-end; 
        margin-left: auto; 
        border-radius: 12px 12px 0 12px; 
    } 
    
    .repartidor { 
        background-color: var(--color-primary); 
        color: var(--color-secondary); 
        align-self: flex-start; 
        margin-right: auto; 
        border-radius: 12px 12px 12px 0; 
    }
    
    .chat-info { font-size: 10px; margin-top: 4px; display: block; text-align: right; color: rgba(255, 255, 255, 0.7); }
    .repartidor .chat-info { color: var(--color-secondary); text-align: left; }
    
    .chat-date-separator {
        text-align: center;
        margin: 15px 0 10px 0;
        font-size: 12px;
        color: var(--color-text-dark);
        position: relative;
    }
    .chat-date-separator::before,
    .chat-date-separator::after {
        content: "";
        position: absolute;
        top: 50%;
        width: 35%;
        height: 1px;
        background-color: var(--color-date-separator);
    }
    .chat-date-separator::before { left: 0; }
    .chat-date-separator::after { right: 0; }

    .chat-input-area {
        display: flex;
        flex-wrap: wrap; 
        gap: 5px;
        margin-top: 10px;
        position: sticky;
        bottom: 0;
        background-color: var(--color-card);
        padding: 10px;
        z-index: 100;
        border-top: 1px solid #555;
    }
    
    #inputChat { 
        flex-grow: 1;
        background-color: #444; 
        border: 1px solid #555;
        color: #FFFFFF !important; 
        min-width: 60%; 
    }
    
    #btnEnviarMensaje, .chat-action-btn {
        width: auto;
        padding: 10px 15px;
        margin: 0;
        font-size: 14px;
        flex-shrink: 0;
    }

    .chat-action-btn {
        background-color: #555;
        color: var(--color-text-light);
    }
    .chat-action-btn:hover:not(:disabled) {
        background-color: #777;
    }
    .chat-action-btn.active-tab {
        background-color: var(--color-primary); 
        color: var(--color-secondary);
    }

    #file-input-chat {
        display: none;
    }

    .chat-media-container {
        margin-top: 5px;
        max-width: 100%;
    }
    
    .chat-media-container img {
        max-width: 100%;
        max-height: 250px;
        width: auto;
        height: auto;
        border-radius: 8px;
        cursor: pointer;
        display: block;
        object-fit: cover;
    }
    
    .chat-media-container audio {
        width: 100%;
        max-width: 280px;
        margin-top: 5px;
        border-radius: 20px;
        display: none; /* Ocultamos el reproductor nativo */
    }
    
    /* Reproductor de audio personalizado tipo WhatsApp */
    .custom-audio-player {
        display: flex;
        align-items: center;
        background-color: rgba(255, 255, 255, 0.15);
        border-radius: 25px;
        padding: 15px 18px;
        width: 100%;
        max-width: 100%;
        gap: 12px;
        min-height: 60px;
    }
    
    .custom-audio-player .play-btn {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background-color: var(--color-primary);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        flex-shrink: 0;
        transition: background-color 0.2s;
    }
    
    .custom-audio-player .play-btn:hover {
        background-color: #ffaa00;
    }
    
    .custom-audio-player .audio-info {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 5px;
        min-width: 0;
    }
    
    .custom-audio-player .audio-progress {
        width: 100%;
        height: 5px;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
        position: relative;
        cursor: pointer;
    }
    
    .custom-audio-player .audio-progress-bar {
        height: 100%;
        background-color: var(--color-primary);
        border-radius: 2px;
        width: 0%;
        transition: width 0.1s linear;
    }
    
    .custom-audio-player .audio-time {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.8);
        font-weight: 500;
    }
    
    .media-caption {
        font-size: 11px;
        margin-top: 5px;
        opacity: 0.9;
        word-wrap: break-word;
    }
    
    .mensaje a.detected-link {
        color: var(--color-link);
        text-decoration: underline;
        word-break: break-all;
    }
    
    .usuario a.detected-link {
        color: #87CEEB;
    }

    .chat-solicitud { color: var(--color-text-dark); }
    #aviso-chat { padding: 15px; background-color: #383838; border: 1px solid #555; border-radius: 8px; text-align: left; margin-top: 15px; display: none; color: var(--color-text-light); }
    #aviso-chat ul { padding-left: 20px; margin: 10px 0; }
    #aviso-chat p { font-weight: bold; color: var(--color-primary);}
    #aviso-chat button { background-color: #28a745; margin-top: 15px; }
    #aviso-chat button:hover { background-color: #218838; }

    #bloqueo-aprobacion {
        padding: 20px;
        background-color: #4d0000;
        border: 1px solid #800000;
        border-radius: 8px;
        color: #ffcccc;
        font-weight: bold;
        text-align: center;
        margin-bottom: 15px;
        display: none; 
    }

    
    #splash-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--color-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.5s ease-out;
    }
    #splash-logo {
        max-width: 80%;
        height: auto;
    }
    #btn-activar-notif {
        width: 100%;
        padding: 10px;
        margin-top: 15px;
        background-color: #6a1b9a;
        color: var(--color-text-light);
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.3s;
    }
    #btn-activar-notif:hover {
        background-color: #8e24aa;
    }

    .support-btn {
        background-color: var(--color-success);
        color: white;
        margin-top: 10px;
    }
    .support-btn:hover {
        background-color: #218838;
    }
    
    #file-upload-status {
        width: 100%;
        text-align: center;
        margin-top: 10px;
        color: var(--color-primary);
        font-weight: bold;
        display: none;
    }

    #audio-recording-status {
        text-align: center;
        margin-top: 10px;
        color: #ff4444;
        font-weight: bold;
        display: none;
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .recording-active {
        background-color: #ff4444 !important;
        animation: pulse 1.5s infinite;
    }

    /* ------------------- ESTILOS PARA SEGUIMIENTO DE PEDIDO ------------------- */
    .tracking-btn {
        background-color: #2196F3;
        color: white;
        margin-top: 10px;
    }
    .tracking-btn:hover {
        background-color: #1976D2;
    }

    #tracking-result {
        background-color: #2C2C2C;
        border: 1px solid #555;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        display: none;
    }

    .estado-badge {
        display: inline-block;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: bold;
        margin: 10px 0;
        font-size: 14px;
    }

    .estado-pendiente { background-color: #FFD700; color: #000; }
    .estado-aceptado { background-color: #007bff; color: #fff; }
    .estado-esperando-pedido { background-color: #E67E22; color: #fff; }
    .estado-en-camino { background-color: #2980B9; color: #fff; }
    .estado-entregado { background-color: #28a745; color: #fff; }
    .estado-completado { background-color: #28a745; color: #fff; }
    .estado-cancelado { background-color: #dc3545; color: #fff; }

    .pedido-detalle {
        text-align: left;
        margin: 10px 0;
        padding: 8px;
        background-color: #444;
        border-radius: 6px;
        border-left: 3px solid var(--color-primary);
    }

    .pedido-detalle strong {
        color: var(--color-primary);
        display: block;
        margin-bottom: 5px;
    }

    .pedido-detalle p {
        margin: 3px 0;
        color: var(--color-text-light);
        font-size: 14px;
    }

    #tracking-status-message {
        text-align: center;
        color: var(--color-primary);
        margin-top: 10px;
        font-weight: bold;
    }

    .ubicacion-btn {
        background-color: #2980B9;
        color: white;
        margin-top: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    .ubicacion-btn:hover {
        background-color: #3498db;
    }
    .ubicacion-btn:disabled {
        background-color: #555;
        color: #999;
        cursor: not-allowed;
    }

    #map-container {
        width: 100%;
        height: 400px;
        margin: 15px 0;
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid var(--color-primary);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        display: none;
    }

    #map {
        width: 100%;
        height: 100%;
    }

    .map-info-box {
        background: var(--color-card);
        border: 1px solid #555;
        border-radius: 8px;
        padding: 10px;
        margin: 10px 0;
        color: var(--color-text-light);
    }

    .map-info-box strong {
        color: var(--color-primary);
        display: block;
        margin-bottom: 5px;
    }

    .map-legend {
        display: flex;
        justify-content: space-around;
        margin: 10px 0;
        padding: 10px;
        background: #2a2a2a;
        border-radius: 8px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
    }

    .legend-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
    }

    .legend-cliente { background-color: #4CAF50; }
    .legend-repartidor { background-color: #2196F3; }
    /* ================= MEN√ö HAMBURGUESA ================= */
    .menu-ham-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
    }

    .menu-ham-btn {
        width: 50px;
        height: 50px;
        background: var(--color-primary);
        border: none;
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 10px;
        box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
        transition: all 0.3s ease;
    }

    .menu-ham-btn:hover {
        background: #ffaa00;
        transform: scale(1.05);
        box-shadow: 0 6px 16px rgba(255, 215, 0, 0.5);
    }

    .menu-ham-btn:active {
        transform: scale(0.95);
    }

    .menu-ham-line {
        width: 25px;
        height: 3px;
        background: var(--color-secondary);
        border-radius: 3px;
        transition: all 0.3s ease;
    }

    .menu-ham-btn.active .menu-ham-line:nth-child(1) {
        transform: rotate(45deg) translate(8px, 8px);
    }

    .menu-ham-btn.active .menu-ham-line:nth-child(2) {
        opacity: 0;
    }

    .menu-ham-btn.active .menu-ham-line:nth-child(3) {
        transform: rotate(-45deg) translate(8px, -8px);
    }

    .menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        z-index: 9998;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .menu-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .menu-lateral {
        position: fixed;
        top: 0;
        right: -350px;
        width: 320px;
        max-width: 90vw;
        height: 100vh;
        background: var(--color-card);
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.5);
        z-index: 9999;
        transition: right 0.3s ease;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .menu-lateral.active {
        right: 0;
    }

    .menu-header {
        background: linear-gradient(135deg, var(--color-primary), #ffaa00);
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .menu-header h3 {
        margin: 0;
        color: var(--color-secondary);
        font-size: 20px;
    }

    .menu-close-btn {
        background: rgba(0, 0, 0, 0.2);
        border: none;
        color: var(--color-secondary);
        width: 35px;
        height: 35px;
        border-radius: 50%;
        font-size: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .menu-close-btn:hover {
        background: rgba(0, 0, 0, 0.4);
        transform: rotate(90deg);
    }

    .menu-content {
        padding: 20px;
        flex: 1;
    }

    .menu-section {
        margin-bottom: 25px;
    }

    .menu-section-title {
        color: var(--color-primary);
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid #555;
    }

    .menu-item {
        background: #2a2a2a;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s;
        border: 1px solid #444;
    }

    .menu-item:hover {
        background: #333;
        border-color: var(--color-primary);
        transform: translateX(-3px);
    }

    .menu-item-info {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
    }

    .menu-item-icon {
        font-size: 24px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 215, 0, 0.1);
        border-radius: 8px;
    }

    .menu-item-text {
        display: flex;
        flex-direction: column;
        gap: 3px;
    }

    .menu-item-text strong {
        color: var(--color-text-light);
        font-size: 14px;
    }

    .menu-item-text small {
        color: var(--color-text-dark);
        font-size: 12px;
    }

    .menu-item-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        background: var(--color-primary);
        color: var(--color-secondary);
        font-weight: bold;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .menu-item-btn:hover {
        background: #ffaa00;
        transform: scale(1.05);
    }

    .menu-item-btn:disabled {
        background: #555;
        color: #999;
        cursor: not-allowed;
        transform: none;
    }

    .menu-item-btn.granted {
        background: var(--color-success);
        color: white;
    }

    .menu-item-btn.denied {
        background: #dc3545;
        color: white;
    }

    .status-granted {
        color: var(--color-success) !important;
    }

    .status-denied {
        color: #dc3545 !important;
    }

    .status-prompt {
        color: #ffa500 !important;
    }

    @media (max-width: 768px) {
        .menu-lateral {
            width: 100%;
            max-width: 100%;
            right: -100%;
        }
        
        .menu-ham-container {
            top: 15px;
            right: 15px;
        }
        
        .menu-ham-btn {
            width: 45px;
            height: 45px;
        }

        #map-container {
            height: 300px;
        }
    }

    .menu-lateral::-webkit-scrollbar {
        width: 8px;
    }

    .menu-lateral::-webkit-scrollbar-track {
        background: #1a1a1a;
    }

    .menu-lateral::-webkit-scrollbar-thumb {
        background: var(--color-primary);
        border-radius: 4px;
    }

    .menu-lateral::-webkit-scrollbar-thumb:hover {
        background: #ffaa00;
    }

    .custom-marker-cliente {
        background-color: #4CAF50;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }

    .custom-marker-repartidor {
        background-color: #2196F3;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }

    .leaflet-popup-content-wrapper {
        background: var(--color-card);
        color: var(--color-text-light);
        border-radius: 8px;
    }

    .leaflet-popup-content {
        margin: 10px;
        font-size: 14px;
    }

    .leaflet-popup-tip {
        background: var(--color-card);
    }

    /* üÜï INDICADOR DE GPS ACTIVO PARA EL CLIENTE */
    .gps-indicator-cliente {
        position: fixed;
        bottom: 20px;
        left: 20px;
        background: #27ae60;
        color: white;
        padding: 10px 15px;
        border-radius: 25px;
        font-size: 0.85em;
        font-weight: bold;
        z-index: 1000;
        display: none;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 15px rgba(39, 174, 96, 0.5);
        animation: pulse-gps-cliente 2s infinite;
    }

    .gps-indicator-cliente.active {
        display: flex;
    }

    @keyframes pulse-gps-cliente {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .gps-dot-cliente {
        width: 10px;
        height: 10px;
        background: white;
        border-radius: 50%;
        animation: blink-cliente 1s infinite;
    }

    @keyframes blink-cliente {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }
  </style>
</head>
<body>
  <!-- MEN√ö HAMBURGUESA -->
  <div id="menu-hamburguesa" class="menu-ham-container">
      <button id="btn-menu" class="menu-ham-btn" onclick="toggleMenu()">
          <span class="menu-ham-line"></span>
          <span class="menu-ham-line"></span>
          <span class="menu-ham-line"></span>
      </button>
  </div>

  <div id="menu-lateral" class="menu-lateral">
      <div class="menu-header">
          <h3>‚öôÔ∏è Ajustes</h3>
          <button class="menu-close-btn" onclick="toggleMenu()">‚úï</button>
      </div>
      
      <div class="menu-content">
          <div class="menu-section">
              <h4 class="menu-section-title">üîí Permisos</h4>
              
              <div class="menu-item">
                  <div class="menu-item-info">
                      <span class="menu-item-icon">üîî</span>
                      <div class="menu-item-text">
                          <strong>Notificaciones</strong>
                          <small id="notif-status">Verificando...</small>
                      </div>
                  </div>
                  <button id="btn-permiso-notif" class="menu-item-btn" onclick="solicitarPermisoNotificaciones()">
                      Activar
                  </button>
              </div>
              
              <div class="menu-item">
                  <div class="menu-item-info">
                      <span class="menu-item-icon">üì∑</span>
                      <div class="menu-item-text">
                          <strong>C√°mara</strong>
                          <small id="camera-status">Verificando...</small>
                      </div>
                  </div>
                  <button id="btn-permiso-camera" class="menu-item-btn" onclick="solicitarPermisoCamara()">
                      Activar
                  </button>
              </div>
              
              <div class="menu-item">
                  <div class="menu-item-info">
                      <span class="menu-item-icon">üéôÔ∏è</span>
                      <div class="menu-item-text">
                          <strong>Micr√≥fono</strong>
                          <small id="mic-status">Verificando...</small>
                      </div>
                      </div>
                  <button id="btn-permiso-mic" class="menu-item-btn" onclick="solicitarPermisoMicrofono()">
                      Activar
                  </button>
              </div>

              <div class="menu-item">
                  <div class="menu-item-info">
                      <span class="menu-item-icon">üìç</span>
                      <div class="menu-item-text">
                          <strong>Ubicaci√≥n GPS</strong>
                          <small id="location-status">Verificando...</small>
                      </div>
                  </div>
                  <button id="btn-permiso-location" class="menu-item-btn" onclick="solicitarPermisoUbicacion()">
                      Activar
                  </button>
              </div>
          </div>
          
          <div class="menu-section">
              <h4 class="menu-section-title">üîß M√°s Ajustes</h4>
              <div class="menu-item">
                  <div class="menu-item-info">
                      <span class="menu-item-icon">‚ÑπÔ∏è</span>
                      <div class="menu-item-text">
                          <strong>Versi√≥n</strong>
                          <small>Cliente v2.4.0 - Routing Fix</small>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <div id="menu-overlay" class="menu-overlay" onclick="toggleMenu()"></div>

  <!-- üÜï INDICADOR GPS ACTIVO DEL CLIENTE -->
  <div id="gps-indicator-cliente" class="gps-indicator-cliente">
      <div class="gps-dot-cliente"></div>
      <span>üìç GPS Activo</span>
  </div>

  <div id="splash-screen">
      <img id="splash-logo" src="https://i.ibb.co/hJCtmHsf/1761849436845.png" alt="Servi Aliados Logo">
  </div>
  <div class="container" id="main-container" style="display:none;">

    <div id="vista-inicio">
      <h2>Bienvenido</h2>
      <p style="color:var(--color-text-dark);">Inicia sesi√≥n o reg√≠strate con tu correo y contrase√±a:</p>
      
      <div class="auth-group">
          <label for="email-input">Correo Electr√≥nico:</label>
          <input type="email" id="email-input" placeholder="tu.correo@ejemplo.com" required>
      </div>
      <div class="auth-group">
          <label for="password-input">Contrase√±a:</label>
          <input type="password" id="password-input" required>
      </div>
      
      <div id="auth-status"></div>
      
      <button onclick="registrarConCorreo()">Registrarse (Crear Cuenta)</button>
      <button onclick="iniciarSesionConCorreo()">Iniciar Sesi√≥n</button>
    </div>

    <form id="vista-registro-complemento" style="display:none;">
      <h3>Completa tu Registro</h3>
      <p style="font-size: 14px; color: var(--color-text-dark);">Falta informaci√≥n esencial para solicitar domicilios.</p>
      
      <label>Nombre completo: <span style="color:var(--color-primary);">*</span></label>
      <input type="text" id="nombreUsuario" required> 
      <label>Correo Electr√≥nico:</label>
      <input type="email" id="correoUsuario" required readonly> 
      <label>Tel√©fono principal: <span style="color:var(--color-primary);">*</span></label>
      <input type="tel" id="telefono1Usuario" required>
      <label>Tel√©fono secundario (opcional):</label>
      <input type="tel" id="telefono2Usuario">
      <label>Direcci√≥n de residencia: <span style="color:var(--color-primary);">*</span></label>
      <input type="text" id="direccionUsuario" required>

      <button type="button" onclick="registrarUsuarioComplemento()">Guardar y Continuar</button>
      <button type="button" class="back-btn" onclick="signOutUser()">Cerrar Sesi√≥n</button>
    </form>

   <div id="vista-cliente" style="display:none;">
      
      <div class="tabs-container">
          <button id="tab-perfil" class="tab-button active-tab" onclick="changeTab('perfil')">üë§ Perfil</button>
          <button id="tab-servicio" class="tab-button" onclick="changeTab('servicio')">üì¶ Servicio</button>
          <button id="tab-tracking" class="tab-button tracking-btn" onclick="changeTab('tracking')">üìç Seguir</button>
      </div>

      <div id="content-perfil" class="tab-content active-content">
          <h3 style="color:var(--color-text-light);">Informaci√≥n del Cliente</h3>
          <div class="dato">
            <strong>Nombre:</strong> <span id="nombrePerfil"></span>
          </div>
          <div class="dato">
            <strong>Correo:</strong> <span id="correoPerfil"></span>
          </div>
          <div class="dato">
            <strong>Tel√©fono 1:</strong> <span id="tel1Perfil"></span>
          </div>
          <div class="dato">
            <strong>Tel√©fono 2:</strong> <span id="tel2Perfil">No registrado</span>
          </div>
          <div class="dato">
            <strong>Direcci√≥n:</strong> <span id="dirPerfil"></span>
          </div>
          <button type="button" class="support-btn" onclick="window.open('https://wa.me/3137065977', '_blank')">
             üìû Soporte WhatsApp
          </button>

          <button type="button" class="back-btn" onclick="signOutUser()">Cerrar Sesi√≥n</button>
      </div>
      
      <div id="content-servicio" class="tab-content">
          <div id="bloqueo-aprobacion">
              Tu cuenta est√° **Bloqueada**. Contacta al administrador si crees que es un error.
          </div>
          
          <div id="chat-container">
              <div class="terminos-box">
                  <input type="checkbox" id="terminos-check" onchange="habilitarChat()">
                  <label for="terminos-check" style="display:inline; font-weight: normal; color: var(--color-text-dark);">Acepto los t√©rminos y condiciones.</label>
              </div>
              
       <button id="btnSolicitarChat" onclick="mostrarAviso()" disabled>Solicitar Servicio (Chat con Central)</button>
              <div class="chat-solicitud">Presiona para solicitar un nuevo servicio.</div>

              <button id="btn-activar-notif" onclick="requestNotificationPermission()" style="display:none;">üîî Activar Notificaciones de Chat</button>

              <div id="aviso-chat">
                  <p>¬°Hola! Soy el asistente de la central. Tu direcci√≥n de recogida es: **<span id="dirSeleccionadaChat"></span>**</p>
                  <ul>
                      <li>**Paquete y Direcci√≥n de Entrega (Punto B):** Por favor, adjunta una foto si el paquete es delicado. Env√≠a la direcci√≥n de **entrega (Punto B)** completa y clara.</li>
                      <li>**Vueltos (Cambio):** Si necesitas un vuelto espec√≠fico para el pago, ¬°hazlo saber!</li>
                  </ul>
                  <button onclick="iniciarChatFinal()" style="background-color: #28a745;">Entendido. Iniciar Chat</button> 
              </div>

              <div id="chat-box">Selecciona "Entendido. Iniciar Chat" para conectar con la Central.</div>
              
              <div class="chat-input-area">
                <button type="button" class="chat-action-btn" id="btn-foto" onclick="activarSelectorFoto()">üì∑ Foto</button>
                <button type="button" class="chat-action-btn" id="btn-audio" onclick="toggleGrabarAudio()">üéôÔ∏è Grabar</button>

                <input id="inputChat" placeholder="Escribe un mensaje..." style="display:none;" onkeypress="if(event.key === 'Enter') enviarMensajeFirebase()">
                <button id="btnEnviarMensaje" style="display:none; width: auto;" onclick="enviarMensajeFirebase()">Enviar</button>
              </div>
              
              <input type="file" id="file-input-chat" accept="image/*" style="display:none;" onchange="manejarArchivoSeleccionado(event)">
              
              <div id="audio-recording-status"></div>
              <div id="file-upload-status"></div>
          </div>
      </div>

      <div id="content-tracking" class="tab-content">
          <h3>üó∫Ô∏è Seguimiento de Pedido en Tiempo Real</h3>
          <p style="font-size: 14px; color: var(--color-text-dark);">Ingresa el correo con el que te registraste:</p>
          <input type="email" id="tracking-email-input" placeholder="tu.correo@ejemplo.com">
          <button onclick="buscarPedidoPorCorreo()">Buscar Pedido</button>
          <div id="tracking-status-message"></div>
          
          <div id="map-container">
              <div id="map"></div>
          </div>
          
          <div id="map-legend" class="map-legend" style="display:none;">
              <div class="legend-item">
                  <div class="legend-icon legend-cliente"></div>
                  <span>üìç Tu Ubicaci√≥n</span>
              </div>
              <div class="legend-item">
                  <div class="legend-icon legend-repartidor"></div>
                  <span>üèçÔ∏è Repartidor</span>
              </div>
          </div>

          <div id="map-info" class="map-info-box" style="display:none;">
              <strong>üìä Informaci√≥n del Seguimiento</strong>
              <p id="map-distance">Calculando distancia...</p>
              <p id="map-duration">Calculando tiempo estimado...</p>
          </div>
          
          <div id="tracking-result"></div>
      </div>
      
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>
    eruda.init();
    console.log('‚úÖ Eruda inicializado correctamente');
  </script>
 <script>
    // ======================================================================
    // === VARIABLES GLOBALES ===
    // ======================================================================
    
    let currentUserID = null; 
    let currentAuthUser = null; 
    let activePedidoID = null; 
    let activePedidoListener = null; 
    let USER_NAME = null; 
    let notificationPermission = 'default';
    let lastMessageDate = null; 
    let currentMediaType = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    let permisosMultimediaSolicitados = false;
    let notificationPermissionRequested = false;
    let menuAbierto = false;
    
    // üÜï VARIABLES PARA ENV√çO AUTOM√ÅTICO DE UBICACI√ìN DEL CLIENTE
    let clienteLocationWatchId = null;
    let isClienteLocationActive = false;
    let lastClienteLocationUpdate = 0;
    const CLIENTE_LOCATION_INTERVAL = 5000; // Cada 5 segundos
    
    // VARIABLES PARA EL MAPA Y SEGUIMIENTO
    let map = null;
    let clienteMarker = null;
    let repartidorMarker = null;
    let routingControl = null;
    let repartidorUbicacionListener = null;
    let currentRepartidorUID = null;
    let clienteCoords = null;
    let watchPositionId = null;
    let locationPermissionGranted = false;
    let currentPedidoId = null;
    
    const notificationSound = new Audio('https://github.com/dt9650329-ops/Chat-administrador-/raw/f67a159f93aed6be1d6f7f02709384111cd84b7e/%E2%9C%A8Monedas%20Cayendo%20__%20Efectos%20De%20Sonidos(MP3_160K).mp3');
    notificationSound.volume = 0.8;
    notificationSound.preload = 'auto';
    notificationSound.load();
    
    const MESSAGE_EXPIRATION_TIME = 24 * 60 * 60 * 1000;
    
    function getClientID(uid) {
        return `cliente_auth_${uid}`;
    }
    window.getClientID = getClientID;
    
    // ======================================================================
    // üÜï SISTEMA DE ENV√çO AUTOM√ÅTICO DE UBICACI√ìN DEL CLIENTE A FIREBASE
    // ======================================================================
    
    function iniciarEnvioUbicacionCliente() {
        if (isClienteLocationActive) {
            console.log('‚ö†Ô∏è Sistema de ubicaci√≥n del cliente ya est√° activo');
            return;
        }
        
        if (!navigator.geolocation) {
            console.error('‚ùå Geolocalizaci√≥n no soportada');
            return;
        }
        
        console.log('üìç Iniciando env√≠o autom√°tico de ubicaci√≥n del cliente...');
        isClienteLocationActive = true;
        
        document.getElementById('gps-indicator-cliente').classList.add('active');
        
        clienteLocationWatchId = navigator.geolocation.watchPosition(
            (position) => {
                const now = Date.now();
                
                if (now - lastClienteLocationUpdate < CLIENTE_LOCATION_INTERVAL) {
                    return;
                }
                
                lastClienteLocationUpdate = now;
                
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                console.log(`üìç Ubicaci√≥n Cliente: ${lat.toFixed(6)}, ${lng.toFixed(6)} (¬±${Math.round(accuracy)}m)`);
                
                enviarUbicacionClienteAFirebase(lat, lng, accuracy);
            },
            (error) => {
                console.error('‚ùå Error GPS Cliente:', error.message);
                
                if (error.code === error.PERMISSION_DENIED) {
                    console.error('‚ö†Ô∏è Permiso de ubicaci√≥n denegado');
                    detenerEnvioUbicacionCliente();
                    alert('‚ö†Ô∏è IMPORTANTE: Permiso de ubicaci√≥n denegado.\n\n' +
                          'Sin este permiso NO podr√°s usar el seguimiento en tiempo real.\n\n' +
                          'Para activarlo:\n' +
                          '1. Ve al men√∫ hamburguesa (arriba derecha)\n' +
                          '2. Activa el permiso de Ubicaci√≥n GPS\n' +
                          '3. O ve a Configuraci√≥n del navegador');
                }
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
        
        console.log('‚úÖ Sistema de ubicaci√≥n del cliente iniciado (cada 5s)');
    }
    
    async function enviarUbicacionClienteAFirebase(lat, lng, accuracy) {
        if (!currentUserID || !window.db || !window.ref || !window.update) {
            console.warn('‚ö†Ô∏è No se puede enviar ubicaci√≥n: sistema no inicializado');
            return;
        }
        
        try {
            const timestamp = Date.now();
            const googleMapsUrl = `https://www.google.com/maps?q=${lat},${lng}`;
            
            await window.update(window.ref(window.db, `usuarios/${currentUserID}`), {
                ubicacion: {
                    lat: parseFloat(lat.toFixed(6)),
                    lon: parseFloat(lng.toFixed(6))
                },
                ubicacionActual: {
                    lat: parseFloat(lat.toFixed(6)),
                    lon: parseFloat(lng.toFixed(6)),
                    accuracy: Math.round(accuracy),
                    timestamp: timestamp,
                    googleMapsUrl: googleMapsUrl
                },
                lastSeen: timestamp,
                gpsActivo: true
            });
            
            console.log(`‚úÖ Ubicaci√≥n Cliente ‚Üí Firebase: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
            
        } catch (error) {
            console.error('‚ùå Error al enviar ubicaci√≥n del cliente:', error);
        }
    }
    
    function detenerEnvioUbicacionCliente() {
        if (clienteLocationWatchId !== null) {
            navigator.geolocation.clearWatch(clienteLocationWatchId);
            clienteLocationWatchId = null;
        }
        
        isClienteLocationActive = false;
        console.log('üõë Env√≠o de ubicaci√≥n del cliente detenido');
        
        document.getElementById('gps-indicator-cliente').classList.remove('active');
        
        if (currentUserID && window.db && window.ref && window.update) {
            window.update(window.ref(window.db, `usuarios/${currentUserID}`), {
                gpsActivo: false
            }).catch(err => console.error('Error al actualizar estado GPS:', err));
        }
    }
    
    // ======================================================================
    // === FUNCIONES DE UTILIDAD Y UI ===
    // ======================================================================
    
    function mostrarVista(vistaId) {
        const mainContainer = document.getElementById("main-container");
        mainContainer.querySelectorAll(':scope > div, :scope > form').forEach(child => {
            child.style.display = 'none';
        });
        mainContainer.style.display = 'block'; 
        document.getElementById(vistaId).style.display = 'block';
    }

    function changeTab(tabName) {
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active-tab'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active-content'));

        document.getElementById(`tab-${tabName}`).classList.add('active-tab');
        document.getElementById(`content-${tabName}`).classList.add('active-content');
        
        if (tabName === 'servicio') {
            habilitarChat(); 
            checkNotificationPermission();
        }
        
        if (tabName === 'tracking') {
            document.getElementById('tracking-status-message').textContent = '';
            document.getElementById('tracking-result').style.display = 'none';
            document.getElementById('map-container').style.display = 'none';
            document.getElementById('map-legend').style.display = 'none';
            document.getElementById('map-info').style.display = 'none';
        }
    }

    function habilitarChat() {
        const checked = document.getElementById("terminos-check").checked;
        const btnChat = document.getElementById("btnSolicitarChat");
        const servicioBloqueado = document.getElementById("tab-servicio").disabled;
        btnChat.disabled = servicioBloqueado || !checked;
    }
// Funci√≥n para mostrar el aviso antes de iniciar el chat
    window.mostrarAviso = function() {
        const direccion = document.getElementById("dirPerfil") ? document.getElementById("dirPerfil").textContent : "No disponible";
        document.getElementById("dirSeleccionadaChat").textContent = direccion;
        document.getElementById("aviso-chat").style.display = "block";
        document.getElementById("btnSolicitarChat").style.display = "none";
        console.log('üìã Mostrando aviso de servicio con direcci√≥n:', direccion);
    }

    // Funci√≥n para iniciar el chat despu√©s de aceptar el aviso
    window.iniciarChatFinal = function() {
        document.getElementById("aviso-chat").style.display = "none";
        document.getElementById("chat-box").style.display = "flex";
        document.getElementById("chat-box").innerHTML = "<div style='text-align:center; color: var(--color-text-dark); padding: 20px;'>üí¨ Chat iniciado. La central te responder√° pronto.</div>";
        
        // Mostrar controles del chat
        document.getElementById("inputChat").style.display = "block";
        document.getElementById("btnEnviarMensaje").style.display = "inline-block";
        document.getElementById("btn-foto").style.display = "inline-block";
        document.getElementById("btn-audio").style.display = "inline-block";
        
        console.log('‚úÖ Chat iniciado con la central');
        
        // Iniciar escucha de mensajes si no est√° activa
        if (window.currentUserID) {
            escucharMensajes();
        }
    }
// Funci√≥n para escuchar mensajes en tiempo real desde Firebase
    window.escucharMensajes = function() {
        if (!window.currentUserID) {
            console.error('‚ùå No hay usuario autenticado para escuchar mensajes');
            return;
        }
        
        const chatRef = ref(db, `chats/${window.currentUserID}`);
        
        onValue(chatRef, (snapshot) => {
            const chatBox = document.getElementById("chat-box");
            chatBox.innerHTML = ""; // Limpiar chat
            
            if (snapshot.exists()) {
                const mensajes = snapshot.val();
                const mensajesArray = Object.entries(mensajes).map(([id, data]) => ({id, ...data}));
                
                // Ordenar por timestamp
                mensajesArray.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                
                let lastDate = null;
                
                mensajesArray.forEach(msg => {
                    // Separador de fecha
                    const msgDate = new Date(msg.timestamp).toLocaleDateString('es-ES');
                    if (msgDate !== lastDate) {
                        const dateSeparator = document.createElement('div');
                        dateSeparator.className = 'chat-date-separator';
                        dateSeparator.textContent = msgDate;
                        chatBox.appendChild(dateSeparator);
                        lastDate = msgDate;
                    }
                    
                    // Crear elemento del mensaje
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `mensaje ${msg.remitente === 'Cliente' ? 'usuario' : 'repartidor'}`;
                    
                    // Contenido del mensaje
                    if (msg.tipo === 'texto') {
                        msgDiv.innerHTML = `
                            <div>${msg.mensaje}</div>
                            <span class="chat-info">${formatTimestamp(msg.timestamp)}</span>
                        `;
                    } else if (msg.tipo === 'imagen') {
                        msgDiv.innerHTML = `
                            <div class="chat-media-container">
                                <img src="${msg.url}" alt="Imagen" style="max-width: 100%; border-radius: 8px;">
                            </div>
                            <span class="chat-info">${formatTimestamp(msg.timestamp)}</span>
                        `;
                    } else if (msg.tipo === 'audio') {
                        const audioId = `audio-${msg.timestamp}-${Math.random().toString(36).substr(2, 9)}`;
                        msgDiv.innerHTML = `
                            <div class="chat-media-container">
                                <audio id="${audioId}" src="${msg.url}" style="display:none;"></audio>
                                <div class="custom-audio-player">
                                    <button class="play-btn" onclick="toggleAudioPlay('${audioId}', this)">‚ñ∂Ô∏è</button>
                                    <div class="audio-info">
                                        <div class="audio-progress" onclick="seekAudio(event, '${audioId}')">
                                            <div class="audio-progress-bar" id="${audioId}-progress"></div>
                                        </div>
                                        <div class="audio-time" id="${audioId}-time">0:00</div>
                                    </div>
                                </div>
                            </div>
                            <span class="chat-info">${formatTimestamp(msg.timestamp)}</span>
                        `;
                    }
                    
                    chatBox.appendChild(msgDiv);
                });
                
                // Scroll al final
                chatBox.scrollTop = chatBox.scrollHeight;
            } else {
                chatBox.innerHTML = "<div style='text-align:center; color: var(--color-text-dark); padding: 20px;'>üí¨ Sin mensajes a√∫n.</div>";
            }
        });
        
        console.log('üëÇ Escuchando mensajes en Firebase para:', window.currentUserID);
    }

    // Funci√≥n para enviar mensajes de texto a Firebase
    window.enviarMensajeFirebase = function() {
        const inputChat = document.getElementById("inputChat");
        const mensaje = inputChat.value.trim();
        
        if (!mensaje) {
            console.warn('‚ö†Ô∏è No se puede enviar un mensaje vac√≠o');
            return;
        }
        
        if (!window.currentUserID) {
            alert('Error: No hay sesi√≥n activa');
            return;
        }
        
        const mensajeData = {
            remitente: 'Cliente',
            mensaje: mensaje,
            tipo: 'texto',
            timestamp: Date.now(),
            leido: false
        };
        
        const nuevoMensajeRef = push(ref(db, `chats/${window.currentUserID}`));
        
        set(nuevoMensajeRef, mensajeData)
            .then(() => {
                console.log('‚úÖ Mensaje enviado correctamente');
                inputChat.value = ''; // Limpiar input
            })
            .catch((error) => {
                console.error('‚ùå Error al enviar mensaje:', error);
                alert('Error al enviar mensaje: ' + error.message);
            });
    }

    // ====================================================================
    // FUNCIONES PARA ENVIAR FOTOS
    // ====================================================================
    window.activarSelectorFoto = function() {
        console.log('üì∑ Activando selector de fotos...');
        document.getElementById('file-input-chat').click();
    }

    window.manejarArchivoSeleccionado = async function(event) {
        const file = event.target.files[0];
        if (!file) {
            console.warn('‚ö†Ô∏è No se seleccion√≥ ning√∫n archivo');
            return;
        }

        if (!file.type.startsWith('image/')) {
            alert('‚ö†Ô∏è Por favor selecciona una imagen v√°lida');
            return;
        }

        if (!window.currentUserID) {
            alert('Error: No hay sesi√≥n activa');
            return;
        }

        console.log('üì§ Subiendo imagen...');
        document.getElementById('file-upload-status').style.display = 'block';
        document.getElementById('file-upload-status').textContent = 'üì§ Subiendo imagen...';

        try {
            const timestamp = Date.now();
            const fileName = `chat_${window.currentUserID}_${timestamp}.jpg`;
            const fileRef = storageRef(storage, `chats/${fileName}`);
            
            const uploadTask = uploadBytesResumable(fileRef, file);

            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    document.getElementById('file-upload-status').textContent = `üì§ Subiendo: ${Math.round(progress)}%`;
                },
                (error) => {
                    console.error('‚ùå Error al subir imagen:', error);
                    alert('Error al subir imagen: ' + error.message);
                    document.getElementById('file-upload-status').style.display = 'none';
                },
                async () => {
                    const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                    console.log('‚úÖ Imagen subida correctamente:', downloadURL);

                    const mensajeData = {
                        remitente: 'Cliente',
                        mensaje: '',
                        tipo: 'imagen',
                        url: downloadURL,
                        timestamp: timestamp,
                        leido: false
                    };

                    const nuevoMensajeRef = push(ref(db, `chats/${window.currentUserID}`));
                    await set(nuevoMensajeRef, mensajeData);

                    document.getElementById('file-upload-status').textContent = '‚úÖ Imagen enviada';
                    setTimeout(() => {
                        document.getElementById('file-upload-status').style.display = 'none';
                    }, 2000);

                    event.target.value = '';
                }
            );
        } catch (error) {
            console.error('‚ùå Error al procesar imagen:', error);
            alert('Error al enviar imagen: ' + error.message);
            document.getElementById('file-upload-status').style.display = 'none';
        }
    }

    // ====================================================================
    // FUNCIONES PARA GRABAR Y ENVIAR AUDIO
    // ====================================================================
    window.toggleGrabarAudio = async function() {
        if (isRecording) {
            detenerGrabacion();
        } else {
            await iniciarGrabacion();
        }
    }

    async function iniciarGrabacion() {
        try {
            console.log('üéôÔ∏è Iniciando grabaci√≥n de audio...');
            
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = async () => {
                console.log('üéôÔ∏è Grabaci√≥n detenida, procesando audio...');
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                await enviarAudio(audioBlob);
                
                stream.getTracks().forEach(track => track.stop());
            };

            mediaRecorder.start();
            isRecording = true;

            document.getElementById('btn-audio').textContent = '‚èπÔ∏è Detener';
            document.getElementById('btn-audio').style.backgroundColor = '#ff4444';
            document.getElementById('audio-recording-status').style.display = 'block';
            document.getElementById('audio-recording-status').textContent = 'üî¥ Grabando audio...';

            console.log('‚úÖ Grabaci√≥n iniciada');
        } catch (error) {
            console.error('‚ùå Error al iniciar grabaci√≥n:', error);
            alert('Error al acceder al micr√≥fono: ' + error.message);
        }
    }

    function detenerGrabacion() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            isRecording = false;

            document.getElementById('btn-audio').textContent = 'üéôÔ∏è Grabar';
            document.getElementById('btn-audio').style.backgroundColor = '';
            document.getElementById('audio-recording-status').style.display = 'none';

            console.log('‚úÖ Grabaci√≥n detenida');
        }
    }

    async function enviarAudio(audioBlob) {
        if (!window.currentUserID) {
            alert('Error: No hay sesi√≥n activa');
            return;
        }

        console.log('üì§ Subiendo audio...');
        document.getElementById('audio-recording-status').style.display = 'block';
        document.getElementById('audio-recording-status').textContent = 'üì§ Enviando audio...';

        try {
            const timestamp = Date.now();
            const fileName = `audio_${window.currentUserID}_${timestamp}.webm`;
            const fileRef = storageRef(storage, `chats/${fileName}`);
            
            const uploadTask = uploadBytesResumable(fileRef, audioBlob);

            uploadTask.on('state_changed',
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    document.getElementById('audio-recording-status').textContent = `üì§ Subiendo: ${Math.round(progress)}%`;
                },
                (error) => {
                    console.error('‚ùå Error al subir audio:', error);
                    alert('Error al subir audio: ' + error.message);
                    document.getElementById('audio-recording-status').style.display = 'none';
                },
                async () => {
                    const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                    console.log('‚úÖ Audio subido correctamente:', downloadURL);

                    const mensajeData = {
                        remitente: 'Cliente',
                        mensaje: '',
                        tipo: 'audio',
                        url: downloadURL,
                        timestamp: timestamp,
                        leido: false
                    };

                    const nuevoMensajeRef = push(ref(db, `chats/${window.currentUserID}`));
                    await set(nuevoMensajeRef, mensajeData);

                    document.getElementById('audio-recording-status').textContent = '‚úÖ Audio enviado';
                    setTimeout(() => {
                        document.getElementById('audio-recording-status').style.display = 'none';
                    }, 2000);
                }
            );
        } catch (error) {
            console.error('‚ùå Error al enviar audio:', error);
            alert('Error al enviar audio: ' + error.message);
            document.getElementById('audio-recording-status').style.display = 'none';
        }
    }
    function registrarUsuarioComplemento() {

      const nombre = document.getElementById("nombreUsuario").value.trim();
      const tel1 = document.getElementById("telefono1Usuario").value.trim();
      const direccion = document.getElementById("direccionUsuario").value.trim();

      if (telef || direccion || nombre) {
        alert("Por favor completa los campos obligatorios (Nombre, Tel√©fono principal y Direcci√≥n).");
        return;
      }
      guardarUsuarioEnFirebase(); 
    }

    window.mostrarPerfil = function(usuario) {
      document.getElementById("nombrePerfil").textContent = usuario.nombre;
      document.getElementById("correoPerfil").textContent = usuario.correo || "No disponible";
      document.getElementById("tel1Perfil").textContent = usuario.tel1;
      document.getElementById("tel2Perfil").textContent = usuario.tel2 || "No registrado";
      document.getElementById("dirPerfil").textContent = usuario.direccion; 
      
      window.USER_NAME = usuario.nombre; 
      currentUserID = getClientID(usuario.uid); 
      verificarAprobacion(); 
      
      console.log('üöÄ Iniciando GPS del cliente autom√°ticamente...');
      iniciarEnvioUbicacionCliente();
      
      mostrarVista('vista-cliente'); 
    }

    function formatTimestamp(timestamp) {
        if (!timestamp) return "";
        let date;
        try {
            date = new Date(timestamp);
            if (isNaN(date.getTime()) || date.getTime() > Date.now() + 3600000) { 
                date = new Date(Date.now());
            }
        } catch (e) {
            date = new Date(Date.now());
        }
        const options = { 
            hour: '2-digit', minute: '2-digit',
            hour12: true
        };
        return date.toLocaleString('es-ES', options);
    }

    // Funciones para el reproductor de audio personalizado
    function toggleAudioPlay(audioId, button) {
        const audio = document.getElementById(audioId);
        const progressBar = document.getElementById(`${audioId}-progress`);
        const timeDisplay = document.getElementById(`${audioId}-time`);
        
        if (audio.paused) {
            // Pausar cualquier otro audio que est√© reproduci√©ndose
            document.querySelectorAll('audio').forEach(a => {
                if (a.id !== audioId && !a.paused) {
                    a.pause();
                    const otherButton = document.querySelector(`button[onclick*="${a.id}"]`);
                    if (otherButton) otherButton.textContent = '‚ñ∂Ô∏è';
                }
            });
            
            audio.play();
            button.textContent = '‚è∏Ô∏è';
            
            // Actualizar progreso
            audio.ontimeupdate = () => {
                const progress = (audio.currentTime / audio.duration) * 100;
                progressBar.style.width = progress + '%';
                
                const currentMin = Math.floor(audio.currentTime / 60);
                const currentSec = Math.floor(audio.currentTime % 60);
                timeDisplay.textContent = `${currentMin}:${currentSec.toString().padStart(2, '0')}`;
            };
            
            audio.onended = () => {
                button.textContent = '‚ñ∂Ô∏è';
                progressBar.style.width = '0%';
                timeDisplay.textContent = formatAudioDuration(audio.duration);
            };
        } else {
            audio.pause();
            button.textContent = '‚ñ∂Ô∏è';
        }
        
        // Mostrar duraci√≥n cuando se carga
        audio.onloadedmetadata = () => {
            if (audio.paused) {
                timeDisplay.textContent = formatAudioDuration(audio.duration);
            }
        };
    }
    
    function seekAudio(event, audioId) {
        const audio = document.getElementById(audioId);
        const progressContainer = event.currentTarget;
        const clickX = event.offsetX;
        const width = progressContainer.offsetWidth;
        const duration = audio.duration;
        
        audio.currentTime = (clickX / width) * duration;
    }
    
    function formatAudioDuration(seconds) {
        if (isNaN(seconds)) return '0:00';
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${min}:${sec.toString().padStart(2, '0')}`;
    }

    function formatDate(timestamp) {
        if (!timestamp) return "";
        let date;
        try {
            date = new Date(timestamp);
            if (isNaN(date.getTime()) || date.getTime() > Date.now() + 3600000) {
                 date = new Date(Date.now()); 
            }
        } catch (e) {
            date = new Date(Date.now());
        }
        const today = new Date();
        const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        const todayOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const isToday = todayOnly.getTime() === dateOnly.getTime();
        const yesterday = new Date(todayOnly);
        yesterday.setDate(todayOnly.getDate() - 1);
        const isYesterday = yesterday.getTime() === dateOnly.getTime();
        if (isToday) return "Hoy";
        if (isYesterday) return "Ayer";
        const options = { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        };
        return date.toLocaleDateString('es-ES', options);
    }
    window.formatDate = formatDate; 

    function hideSplashScreen() {
    const splash = document.getElementById('splash-screen');
    if (splash) {
        splash.style.opacity = '0';
        setTimeout(() => {
            splash.style.display = 'none';
        }, 500); 
    }
}
    window.hideSplashScreen = hideSplashScreen;
    
    function checkNotificationPermission() {
        const btnNotif = document.getElementById('btn-activar-notif');
        if (!('Notification' in window) || !btnNotif) {
            if (btnNotif) btnNotif.style.display = 'none';
            return;
        }
        notificationPermission = Notification.permission;
        if (document.getElementById('content-servicio').classList.contains('active-content')) {
            if (notificationPermission === 'granted') {
                btnNotif.style.display = 'none';
            } else if (notificationPermission === 'denied') {
                btnNotif.style.display = 'block';
                btnNotif.textContent = '‚ùå Permiso Denegado. Activar en ajustes del navegador.';
                btnNotif.disabled = true;
            } else {
                btnNotif.style.display = 'block';
                btnNotif.textContent = 'üîî Activar Notificaciones de Chat';
                btnNotif.disabled = false;
            }
        }
    }
    
    window.requestNotificationPermission = function() {
        if (!('Notification' in window)) {
             alert("Tu navegador no soporta notificaciones.");
             return;
        }
        
        const btnNotif = document.getElementById('btn-activar-notif');
        
        Notification.requestPermission().then(permission => {
            notificationPermission = permission;
            notificationPermissionRequested = true;
            
            if (permission === 'granted') {
                try {
                    notificationSound.currentTime = 0;
                    notificationSound.play().catch(e => console.log("Error al reproducir sonido:", e));
                } catch (e) {
                    console.log("Error en reproducci√≥n:", e);
                }
                
                alert("¬°Notificaciones activadas! üîî\n\nRecibir√°s alertas sonoras y notificaciones cuando la Central te escriba.");
                if (btnNotif) btnNotif.style.display = 'none';
                
                try {
                    new Notification('üîî Notificaciones Activadas', {
                        body: 'As√≠ sonar√°n tus alertas cuando recibas mensajes. ¬°Est√°s listo!',
                        icon: 'https://i.ibb.co/hJCtmHsf/1761849436845.png',
                        badge: 'https://i.ibb.co/hJCtmHsf/1761849436845.png',
                        requireInteraction: false
                    });
                } catch (e) {
                    console.log("Error al enviar notificaci√≥n de prueba:", e);
                }
            } else if (permission === 'denied') {
                alert("Permiso denegado. No podremos enviarte notificaciones.\n\nPuedes activarlas desde la configuraci√≥n de tu navegador.");
                if (btnNotif) {
                    btnNotif.textContent = '‚ùå Permiso Denegado. Activar en ajustes del navegador.';
                    btnNotif.disabled = true;
                }
            }
        });
    }
    
    function solicitarPermisosNotificacionInicial() {
        if (!('Notification' in window)) {
            console.log('Notificaciones no soportadas');
            return;
        }
        
        if (Notification.permission === 'default' && !notificationPermissionRequested) {
            setTimeout(() => {
                if (confirm('¬øDeseas activar las notificaciones para recibir alertas de nuevos mensajes?')) {
                    window.requestNotificationPermission();
                } else {
                    notificationPermissionRequested = true;
                }
            }, 2000);
        } else if (Notification.permission === 'granted') {
            notificationPermission = 'granted';
            notificationPermissionRequested = true;
        }
    }

    function linkifyText(text) {
        const urlRegex = /(https?:\/\/[^\s]+)|(www\.[^\s]+)|([a-zA-Z0-9][a-zA-Z0-9-]+\.[a-zA-Z]{2,}[^\s]*)/gi;
        
        return text.replace(urlRegex, function(url) {
            let href = url;
            
            if (!url.match(/^https?:\/\//i)) {
                href = 'https://' + url;
            }
            
            let displayUrl = url;
            if (url.length > 50) {
                displayUrl = url.substring(0, 47) + '...';
            }
            
            return `<a href="${href}" class="detected-link" target="_blank" rel="noopener noreferrer">${displayUrl}</a>`;
        });
    }

    window.toggleMenu = function() {
        menuAbierto = !menuAbierto;
        
        const menuLateral = document.getElementById('menu-lateral');
        const menuOverlay = document.getElementById('menu-overlay');
        const btnMenu = document.getElementById('btn-menu');
        
        if (menuAbierto) {
            menuLateral.classList.add('active');
            menuOverlay.classList.add('active');
            btnMenu.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            verificarEstadosPermisos();
        } else {
            menuLateral.classList.remove('active');
            menuOverlay.classList.remove('active');
            btnMenu.classList.remove('active');
            document.body.style.overflow = '';
        }
    }

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && menuAbierto) {
            toggleMenu();
        }
    });
    
    // ======================================================================
    // === FUNCIONES DEL MAPA (Para Seguimiento) - üî• CORREGIDAS ===
    // ======================================================================

    function initMap() {
        if (map) {
            map.remove();
            map = null;
        }

        const defaultCoords = [4.710989, -74.072092];
        
        map = L.map('map').setView(defaultCoords, 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        setTimeout(() => {
            if (map) {
                map.invalidateSize();
            }
        }, 100);
        
        console.log('‚úÖ Mapa inicializado correctamente');
    }

    function obtenerUbicacionCliente() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('Geolocalizaci√≥n no soportada'));
                return;
            }

            console.log('üìç Solicitando ubicaci√≥n del cliente...');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const coords = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    console.log('‚úÖ Ubicaci√≥n obtenida:', coords);
                    resolve(coords);
                },
                (error) => {
                    console.error('‚ùå Error al obtener ubicaci√≥n:', error);
                    reject(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        });
    }

    function agregarMarcadorCliente(coords, centrarMapa = false) {
        console.log('üìç Agregando marcador del cliente:', coords);
        
        clienteCoords = coords;
        
        if (clienteMarker) {
            clienteMarker.setLatLng([coords.lat, coords.lng]);
        } else {
            const iconCliente = L.divIcon({
                className: 'custom-marker-cliente',
                html: '<div style="background-color: #4CAF50; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"></div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            clienteMarker = L.marker([coords.lat, coords.lng], { icon: iconCliente })
                .addTo(map)
                .bindPopup('<b>üìç Tu Ubicaci√≥n</b>');
            
            if (centrarMapa) {
                map.setView([coords.lat, coords.lng], 15);
            }
        }
        
        console.log('‚úÖ Marcador del cliente actualizado. clienteCoords guardadas:', clienteCoords);
    }

    function agregarMarcadorRepartidor(coords) {
        console.log('üèçÔ∏è Agregando marcador del repartidor:', coords);
        
        if (repartidorMarker) {
            repartidorMarker.setLatLng([coords.lat, coords.lng]);
        } else {
            const iconRepartidor = L.divIcon({
                className: 'custom-marker-repartidor',
                html: '<div style="background-color: #2196F3; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"></div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            repartidorMarker = L.marker([coords.lat, coords.lng], { icon: iconRepartidor })
                .addTo(map)
                .bindPopup('<b>üèçÔ∏è Repartidor</b>');
        }
        
        console.log('‚úÖ Marcador del repartidor actualizado');
    }

    // üî• FUNCI√ìN MEJORADA PARA TRAZAR RUTAS
    function trazarRuta(clienteCoords, repartidorCoords) {
        console.log('');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üõ£Ô∏è INICIANDO TRAZADO DE RUTA');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üìç Coordenadas Cliente:', clienteCoords);
        console.log('üèçÔ∏è Coordenadas Repartidor:', repartidorCoords);
        
        // ‚úÖ VALIDACI√ìN CR√çTICA
        if (!clienteCoords || !repartidorCoords) {
            console.error('‚ùå ERROR: Faltan coordenadas');
            console.error('   Cliente:', clienteCoords);
            console.error('   Repartidor:', repartidorCoords);
            return;
        }
        
        if (!clienteCoords.lat || !clienteCoords.lng || !repartidorCoords.lat || !repartidorCoords.lng) {
            console.error('‚ùå ERROR: Coordenadas incompletas');
            console.error('   Cliente lat:', clienteCoords.lat, 'lng:', clienteCoords.lng);
            console.error('   Repartidor lat:', repartidorCoords.lat, 'lng:', repartidorCoords.lng);
            return;
        }
        
        // üî• CALCULAR DISTANCIA PARA VERIFICAR SI SON DIFERENTES
        const distance = calcularDistancia(
            clienteCoords.lat, clienteCoords.lng,
            repartidorCoords.lat, repartidorCoords.lng
        );
        
        console.log(`üìè Distancia entre puntos: ${distance.toFixed(2)} metros`);
        
        // ‚úÖ SI LA DISTANCIA ES MUY PEQUE√ëA (< 10 metros), NO TRAZAR RUTA
        if (distance < 10) {
            console.warn('‚ö†Ô∏è Distancia demasiado peque√±a, no se trazar√° ruta');
            document.getElementById('map-distance').textContent = 'üìè Distancia: Muy cerca';
            document.getElementById('map-duration').textContent = '‚è±Ô∏è Llegada inminente';
            return;
        }
        
        // ‚úÖ ELIMINAR RUTA ANTERIOR
        if (routingControl) {
            console.log('üóëÔ∏è Eliminando ruta anterior...');
            map.removeControl(routingControl);
            routingControl = null;
        }

        console.log('üõ£Ô∏è Creando nueva ruta...');
        
        try {
            routingControl = L.Routing.control({
                waypoints: [
                    L.latLng(repartidorCoords.lat, repartidorCoords.lng),
                    L.latLng(clienteCoords.lat, clienteCoords.lng)
                ],
                routeWhileDragging: false,
                showAlternatives: false,
                lineOptions: {
                    styles: [{ color: '#FFD700', opacity: 0.8, weight: 5 }]
                },
                createMarker: function() { return null; },
                addWaypoints: false,
                draggableWaypoints: false,
                fitSelectedRoutes: false,
                show: false // ‚úÖ Ocultar panel de instrucciones
            }).addTo(map);

            routingControl.on('routesfound', function(e) {
                const routes = e.routes;
                const summary = routes[0].summary;
                
                const distanceKm = (summary.totalDistance / 1000).toFixed(2);
                const timeMin = Math.round(summary.totalTime / 60);
                
                document.getElementById('map-distance').textContent = `üìè Distancia: ${distanceKm} km`;
                document.getElementById('map-duration').textContent = `‚è±Ô∏è Tiempo estimado: ${timeMin} min`;
                
                console.log(`‚úÖ Ruta trazada exitosamente: ${distanceKm} km, ${timeMin} min`);
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('');
            });
            
            routingControl.on('routingerror', function(e) {
                console.error('‚ùå Error al trazar ruta:', e);
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.error('');
                
                // ‚úÖ Calcular distancia directa como fallback
                const distKm = (distance / 1000).toFixed(2);
                document.getElementById('map-distance').textContent = `üìè Distancia aprox.: ${distKm} km`;
                document.getElementById('map-duration').textContent = `‚è±Ô∏è No disponible`;
            });
            
        } catch (error) {
            console.error('‚ùå Error cr√≠tico al crear ruta:', error);
            console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.error('');
        }
    }
    
    // üÜï FUNCI√ìN PARA CALCULAR DISTANCIA ENTRE DOS PUNTOS (Haversine)
    function calcularDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // Radio de la Tierra en metros
        const œÜ1 = lat1 * Math.PI / 180;
        const œÜ2 = lat2 * Math.PI / 180;
        const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
        const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

        const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

        return R * c; // Distancia en metros
    }
    
    // ======================================================================
    // === SEGUIMIENTO DE UBICACI√ìN DEL REPARTIDOR (MEJORADO) ===
    // ======================================================================

    function iniciarSeguimientoUbicacion(repartidorUID, pedidoId) {
        console.log('');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üöÄ INICIANDO SEGUIMIENTO DEL REPARTIDOR');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        
        if (!clienteCoords || !clienteCoords.lat || !clienteCoords.lng) {
            console.error('');
            console.error('‚ùå ERROR CR√çTICO: clienteCoords no est√° disponible');
            console.error('clienteCoords actual:', clienteCoords);
            console.error('');
            alert('‚ö†Ô∏è Error: No se pudo obtener tu ubicaci√≥n.\n\nPor favor:\n1. Verifica que el permiso de ubicaci√≥n est√© activado\n2. Recarga la p√°gina\n3. Intenta de nuevo');
            return;
        }
        
        console.log('‚úÖ Verificaci√≥n exitosa: clienteCoords disponible');
        console.log('   Lat:', clienteCoords.lat);
        console.log('   Lng:', clienteCoords.lng);
        console.log('');
        
        if (!repartidorUID) {
            console.error('‚ùå No se proporcion√≥ repartidorUID');
            return;
        }
        
        if (repartidorUbicacionListener && currentRepartidorUID) {
            const oldRef = window.ref(window.db, `repartidores_info/${currentRepartidorUID}`);
            window.off(oldRef, 'value', repartidorUbicacionListener);
            console.log('üõë Listener anterior detenido');
        }
        
        currentRepartidorUID = repartidorUID;
        currentPedidoId = pedidoId;
        
        console.log(`üìç Repartidor UID: ${repartidorUID}`);
        console.log(`üì¶ Pedido ID: ${pedidoId}`);
        console.log('');
        
        const repartidorRef = window.ref(window.db, `repartidores_info/${repartidorUID}`);
        
        repartidorUbicacionListener = window.onValue(repartidorRef, (snapshot) => {
            if (!snapshot.exists()) {
                console.warn('‚ö†Ô∏è Datos del repartidor no disponibles a√∫n');
                return;
            }
            
            const repartidorData = snapshot.val();
            console.log('üì° Datos del repartidor recibidos:', repartidorData);
            
            if (!repartidorData.gpsActivo) {
                console.warn('‚ö†Ô∏è GPS del repartidor no est√° activo');
                document.getElementById('map-distance').textContent = 'üìè Esperando GPS del repartidor...';
                document.getElementById('map-duration').textContent = '‚è±Ô∏è GPS del repartidor inactivo';
                return;
            }
            
            let repartidorCoords = null;
            
            if (repartidorData.ubicacionActual && 
                repartidorData.ubicacionActual.lat && 
                repartidorData.ubicacionActual.lng) {
                
                repartidorCoords = {
                    lat: repartidorData.ubicacionActual.lat,
                    lng: repartidorData.ubicacionActual.lng
                };
                console.log('‚úÖ Ubicaci√≥n del repartidor (ubicacionActual):', repartidorCoords);
                
            } else if (repartidorData.ubicacion && 
                       repartidorData.ubicacion.lat && 
                       repartidorData.ubicacion.lng) {
                
                repartidorCoords = {
                    lat: repartidorData.ubicacion.lat,
                    lng: repartidorData.ubicacion.lng
                };
                console.log('‚úÖ Ubicaci√≥n del repartidor (ubicacion):', repartidorCoords);
            }
            
            if (!repartidorCoords) {
                console.warn('‚ö†Ô∏è No se pudo obtener ubicaci√≥n del repartidor');
                return;
            }
            
            if (!clienteCoords || !clienteCoords.lat || !clienteCoords.lng) {
                console.error('‚ùå clienteCoords perdidas durante la ejecuci√≥n');
                console.error('clienteCoords actual:', clienteCoords);
                return;
            }
            
            console.log('‚úÖ Actualizando mapa con ubicaci√≥n del repartidor');
            agregarMarcadorRepartidor(repartidorCoords);
            
            console.log('‚úÖ Trazando ruta desde repartidor hacia cliente');
            trazarRuta(clienteCoords, repartidorCoords);
        }, (error) => {
            console.error('‚ùå Error en listener del repartidor:', error);
        });
        
        console.log('‚úÖ Listener de ubicaci√≥n del repartidor activado');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('');
    }

    function detenerSeguimientoUbicacion() {
        console.log('üõë Deteniendo seguimiento de ubicaci√≥n...');
        
        if (repartidorUbicacionListener && currentRepartidorUID && window.off && window.ref && window.db) {
            const repartidorRef = window.ref(window.db, `repartidores_info/${currentRepartidorUID}`);
            window.off(repartidorRef, 'value', repartidorUbicacionListener);
            repartidorUbicacionListener = null;
            currentRepartidorUID = null;
            currentPedidoId = null;
            console.log('‚úÖ Listener del repartidor detenido');
        }

        if (watchPositionId !== null) {
            navigator.geolocation.clearWatch(watchPositionId);
            watchPositionId = null;
            console.log('‚úÖ Watch position detenido');
        }

        if (map) {
            if (clienteMarker) {
                map.removeLayer(clienteMarker);
                clienteMarker = null;
            }
            if (repartidorMarker) {
                map.removeLayer(repartidorMarker);
                repartidorMarker = null;
            }
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }
            console.log('‚úÖ Marcadores y rutas eliminados del mapa');
        }

        clienteCoords = null;
        console.log('‚úÖ clienteCoords reiniciadas');
        console.log('üõë Seguimiento completamente detenido');
    }

    function iniciarSeguimientoContinuoCliente() {
        if (!navigator.geolocation) {
            console.error('‚ùå Geolocalizaci√≥n no soportada');
            return;
        }

        if (watchPositionId !== null) {
            navigator.geolocation.clearWatch(watchPositionId);
        }

        console.log('üìç Iniciando seguimiento continuo del cliente...');

        watchPositionId = navigator.geolocation.watchPosition(
            (position) => {
                const coords = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                clienteCoords = coords;
                
                if (map) {
                    agregarMarcadorCliente(coords, false);
                    
                    if (repartidorMarker) {
                        const repartidorPos = repartidorMarker.getLatLng();
                        trazarRuta(coords, { lat: repartidorPos.lat, lng: repartidorPos.lng });
                    }
                }
            },
            (error) => {
                console.error('‚ùå Error al obtener ubicaci√≥n continua:', error);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 5000
            }
        );
        
        console.log('‚úÖ Seguimiento continuo del cliente iniciado');
    }
    
    // ======================================================================
    // === B√öSQUEDA Y SEGUIMIENTO DE PEDIDO ===
    // ======================================================================

    window.buscarPedidoPorCorreo = async function() {
        const email = document.getElementById('tracking-email-input').value.trim();
        const statusDiv = document.getElementById('tracking-status-message');
        const resultDiv = document.getElementById('tracking-result');
        const mapContainer = document.getElementById('map-container');
        const mapLegend = document.getElementById('map-legend');
        const mapInfo = document.getElementById('map-info');
        
        if (!email) {
            statusDiv.textContent = '‚ö†Ô∏è Por favor, ingresa un correo electr√≥nico.';
            statusDiv.style.color = '#FFD700';
            return;
        }

        if (!window.db || !window.ref || !window.get) {
            statusDiv.textContent = '‚ùå Error: Firebase no est√° inicializado.';
            statusDiv.style.color = '#dc3545';
            return;
        }

        statusDiv.textContent = 'üîç Buscando tu pedido...';
        statusDiv.style.color = '#FFD700';
        resultDiv.style.display = 'none';
        resultDiv.innerHTML = '';
        mapContainer.style.display = 'none';
        mapLegend.style.display = 'none';
        mapInfo.style.display = 'none';
        
        detenerSeguimientoUbicacion();

        try {
            const usuariosRef = window.ref(window.db, 'usuarios');
            const usuariosSnapshot = await window.get(usuariosRef);
            
            let userUID = null;
            let userName = 'Cliente';
            
            if (usuariosSnapshot.exists()) {
                usuariosSnapshot.forEach((childSnapshot) => {
                    const userData = childSnapshot.val();
                    if (userData.correo && userData.correo.toLowerCase() === email.toLowerCase()) {
                        userUID = userData.uid;
                        userName = userData.nombre || 'Cliente';
                    }
                });
            }

            if (!userUID) {
                statusDiv.textContent = '‚ùå No se encontr√≥ ning√∫n usuario con ese correo.';
                statusDiv.style.color = '#dc3545';
                return;
            }

            const clienteID = `cliente_auth_${userUID}`;

            const pedidosHistorialRef = window.ref(window.db, 'pedidos_historial');
            const historialSnapshot = await window.get(pedidosHistorialRef);
            
            let pedidosEncontrados = [];
            
            if (historialSnapshot.exists()) {
                historialSnapshot.forEach((childSnapshot) => {
                    const pedido = childSnapshot.val();
                    if (pedido.clienteIdAsignado === clienteID) {
                        pedidosEncontrados.push({
                            id: childSnapshot.key,
                            ...pedido
                        });
                    }
                });
            }

            pedidosEncontrados.sort((a, b) => {
                const timeA = a.timestampAsignacion || a.timestampCreacion || 0;
                const timeB = b.timestampAsignacion || b.timestampCreacion || 0;
                return timeB - timeA;
            });

            if (pedidosEncontrados.length === 0) {
                statusDiv.textContent = 'üî≠ No se encontraron pedidos asociados a este correo.';
                statusDiv.style.color = '#FFD700';
                return;
            }

            const pedidoReciente = pedidosEncontrados[0];
            await mostrarDetallePedido(pedidoReciente, userName, pedidosEncontrados.length);
            
            statusDiv.textContent = '';

        } catch (error) {
            console.error('‚ùå Error al buscar pedido:', error);
            statusDiv.textContent = `‚ùå Error al buscar: ${error.message}`;
            statusDiv.style.color = '#dc3545';
        }
    }
    
    async function mostrarDetallePedido(pedido, userName, totalPedidos) {
        const resultDiv = document.getElementById('tracking-result');
        const mapContainer = document.getElementById('map-container');
        const mapLegend = document.getElementById('map-legend');
        const mapInfo = document.getElementById('map-info');
        
        const estado = pedido.estado || pedido.estadoHistorial || 'Desconocido';
        const estadoClass = `estado-${estado.toLowerCase().replace(/ /g, '-')}`;
        
        const timestamp = pedido.timestampAsignacion || pedido.timestampCreacion || Date.now();
        const fechaCreacion = new Date(timestamp).toLocaleString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });

        let estadoDescripcion = '';
        switch(estado.toLowerCase()) {
            case 'pendiente':
                estadoDescripcion = '‚è≥ Tu pedido est√° pendiente de ser aceptado.';
                break;
            case 'aceptado':
                estadoDescripcion = '‚úÖ El repartidor ha aceptado tu pedido.';
                break;
            case 'esperando':
            case 'esperando pedido':
                estadoDescripcion = 'üè™ El repartidor est√° esperando en el punto de recogida.';
                break;
            case 'en camino':
                estadoDescripcion = 'üöö Tu pedido est√° en camino.';
                break;
            case 'completado':
            case 'entregado':
                estadoDescripcion = 'üéâ ¬°Tu pedido ha sido entregado!';
                break;
            case 'cancelado':
                estadoDescripcion = '‚ùå Este pedido fue cancelado.';
                break;
            default:
                estadoDescripcion = '‚è±Ô∏è Estado actualizado.';
        }

        resultDiv.innerHTML = `
            <h3 style="color: var(--color-primary); margin-top: 0;">üì¶ Tu Pedido</h3>
            
            <div style="text-align: center; margin-bottom: 15px;">
                <span class="estado-badge ${estadoClass}">${estado}</span>
            </div>
            
            <p style="text-align: center; color: var(--color-text-dark); margin-bottom: 20px;">${estadoDescripcion}</p>
            
            <div class="pedido-detalle">
                <strong>ID del Pedido:</strong>
                <p>#${pedido.id ? pedido.id.substring(0, 8) : 'N/A'}...</p>
            </div>
            
            <div class="pedido-detalle">
                <strong>Cliente:</strong>
                <p>${userName}</p>
            </div>
            
            <div class="pedido-detalle">
                <strong>Descripci√≥n:</strong>
                <p>${pedido.descripcion || 'Sin descripci√≥n'}</p>
            </div>
            
            <div class="pedido-detalle">
                <strong>Direcci√≥n de Entrega:</strong>
                <p>${pedido.direccionCliente || 'No especificada'}</p>
            </div>
            
            <div class="pedido-detalle">
                <strong>Tel√©fono:</strong>
                <p>${pedido.telefonoCliente || 'No especificado'}</p>
            </div>
            
            <div class="pedido-detalle">
                <strong>Monto Total:</strong>
                <p style="font-size: 18px; color: var(--color-primary);">$${(pedido.montoTotal || 0).toLocaleString('es-ES')}</p>
            </div>
            
            <div class="pedido-detalle">
                <strong>Repartidor:</strong>
                <p>${pedido.repartidorNombre || 'Pendiente'}</p>
            </div>
            
            <div class="pedido-detalle">
                <strong>Fecha:</strong>
                <p>${fechaCreacion}</p>
            </div>
            
            ${totalPedidos > 1 ? `<p style="text-align: center; color: var(--color-text-dark); margin-top: 15px; font-size: 12px;">Tienes ${totalPedidos} pedidos en total.</p>` : ''}
        `;
        
        resultDiv.style.display = 'block';
        
        // üî• DEBUG: Mostrar informaci√≥n completa del pedido en consola
        console.log('');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üîç DIAGN√ìSTICO COMPLETO DEL PEDIDO');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üì¶ Estado del pedido:', estado);
        console.log('üèçÔ∏è repartidorIdAsignado:', pedido.repartidorIdAsignado || '‚ùå NO ASIGNADO');
        console.log('üÜî repartidorId:', pedido.repartidorId || 'N/A');
        console.log('üë§ repartidorNombre:', pedido.repartidorNombre || 'N/A');
        console.log('üîë repartidorUID:', pedido.repartidorUID || 'N/A');
        console.log('üìã Campos disponibles:', Object.keys(pedido));
        console.log('üéØ Estado en estadosActivos?', ['pendiente', 'aceptado', 'esperando pedido', 'en camino', 'completado', 'entregado'].includes(estado.toLowerCase()));
        console.log('üéØ Tiene repartidorIdAsignado?', !!pedido.repartidorIdAsignado);
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('');
        
        // üî• MOSTRAR MAPA PARA TODOS LOS PEDIDOS QUE TENGAN REPARTIDOR ASIGNADO
        const estadosActivos = ['pendiente', 'aceptado', 'esperando', 'esperando pedido', 'en camino', 'completado', 'entregado'];
        const tieneRepartidor = pedido.repartidorIdAsignado || pedido.repartidorUID || pedido.repartidorId;
        
        if (estadosActivos.includes(estado.toLowerCase()) && tieneRepartidor) {
            console.log('');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üó∫Ô∏è INICIANDO SISTEMA DE SEGUIMIENTO EN TIEMPO REAL');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('‚úÖ Pedido activo detectado');
            console.log('üèçÔ∏è Repartidor asignado:', tieneRepartidor);
            console.log('');
            
            mapContainer.style.display = 'block';
            mapLegend.style.display = 'flex';
            mapInfo.style.display = 'block';
            
            console.log('üó∫Ô∏è Inicializando mapa...');
            initMap();
            
            try {
                console.log('üìç PASO 1: Obteniendo ubicaci√≥n del cliente...');
                const coords = await obtenerUbicacionCliente();
                console.log('‚úÖ Ubicaci√≥n del cliente obtenida:', coords);
                console.log('');
                
                console.log('üìç PASO 2: Guardando en variable global...');
                clienteCoords = coords;
                console.log('‚úÖ clienteCoords guardadas:', clienteCoords);
                console.log('');
                
                console.log('üìç PASO 3: Agregando marcador del cliente...');
                agregarMarcadorCliente(coords, true); // ‚úÖ Centrar mapa la primera vez
                console.log('‚úÖ Marcador del cliente agregado');
                console.log('');
                
                console.log('üìç PASO 4: Iniciando seguimiento continuo...');
                iniciarSeguimientoContinuoCliente();
                console.log('‚úÖ Seguimiento continuo iniciado');
                console.log('');
                
                console.log('‚è≥ PASO 5: Esperando 1 segundo para estabilizar...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                console.log('‚úÖ Sistema estabilizado');
                console.log('');
                
                console.log('üîç PASO 6: Verificaci√≥n final de clienteCoords...');
                if (!clienteCoords || !clienteCoords.lat || !clienteCoords.lng) {
                    throw new Error('‚ö†Ô∏è clienteCoords no est√° definida correctamente');
                }
                console.log('‚úÖ Verificaci√≥n exitosa:');
                console.log('   Lat:', clienteCoords.lat);
                console.log('   Lng:', clienteCoords.lng);
                console.log('');
                
                console.log('üìç PASO 7: Iniciando seguimiento del repartidor...');
                iniciarSeguimientoUbicacion(tieneRepartidor, pedido.id);
                
                console.log('');
                console.log('‚úÖ SISTEMA DE SEGUIMIENTO COMPLETAMENTE INICIADO');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('');
                
            } catch (error) {
                console.error('');
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.error('‚ùå ERROR EN EL PROCESO DE SEGUIMIENTO');
                console.error('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.error('Error:', error);
                console.error('');
                
                if (error.code === 1) {
                    alert('‚ö†Ô∏è IMPORTANTE: Permiso de ubicaci√≥n denegado.\n\n' +
                          'Sin este permiso NO podr√°s usar el seguimiento en tiempo real.\n\n' +
                          'Para activarlo:\n' +
                          '1. Ve al men√∫ hamburguesa (arriba derecha)\n' +
                          '2. Activa el permiso de Ubicaci√≥n GPS\n' +
                          '3. O ve a Configuraci√≥n del navegador');
                } else {
                    alert('‚ö†Ô∏è No se pudo iniciar el seguimiento.\n\nError: ' + error.message);
                }
                
                mapContainer.style.display = 'none';
                mapLegend.style.display =
                'none';
                mapInfo.style.display = 'none';
            }
        } else {
            console.log('');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('‚ÑπÔ∏è MAPA NO DISPONIBLE');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('Raz√≥n: Pedido completado o sin repartidor asignado');
            console.log('Estado del pedido:', estado);
            console.log('Repartidor asignado:', pedido.repartidorIdAsignado || pedido.repartidorUID || pedido.repartidorId || 'Ninguno');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('');
            
            detenerSeguimientoUbicacion();
            mapContainer.style.display = 'none';
            mapLegend.style.display = 'none';
            mapInfo.style.display = 'none';
            
            // Mostrar mensaje informativo al usuario
            const mapInfo = document.getElementById('map-info');
            if (!pedido.repartidorIdAsignado && !pedido.repartidorUID && !pedido.repartidorId) {
                mapInfo.innerHTML = '<p style="text-align: center; color: var(--color-primary); padding: 15px;">‚è≥ <strong>Esperando asignaci√≥n de repartidor...</strong><br><small>El mapa se mostrar√° cuando un repartidor acepte tu pedido</small></p>';
                mapInfo.style.display = 'block';
            }
        }
    }

    // ======================================================================
    // === GESTI√ìN DE PERMISOS ===
    // ======================================================================

    window.verificarEstadosPermisos = async function() {
        if ('Notification' in window) {
            const notifStatus = document.getElementById('notif-status');
            const btnNotif = document.getElementById('btn-permiso-notif');
            
            if (Notification.permission === 'granted') {
                notifStatus.textContent = '‚úÖ Concedido';
                notifStatus.classList.add('status-granted');
                btnNotif.textContent = '‚úì Activo';
                btnNotif.classList.add('granted');
                btnNotif.disabled = true;
            } else if (Notification.permission === 'denied') {
                notifStatus.textContent = '‚ùå Denegado';
                notifStatus.classList.add('status-denied');
                btnNotif.textContent = 'Denegado';
                btnNotif.classList.add('denied');
                btnNotif.disabled = true;
            } else {
                notifStatus.textContent = '‚ö†Ô∏è No concedido';
                notifStatus.classList.add('status-prompt');
                btnNotif.textContent = 'Activar';
                btnNotif.disabled = false;
            }
        }
        
        try {
            const permissions = await navigator.permissions.query({ name: 'camera' });
            actualizarEstadoPermiso('camera', permissions.state);
            
            permissions.addEventListener('change', () => {
                actualizarEstadoPermiso('camera', permissions.state);
            });
        } catch (e) {
            document.getElementById('camera-status').textContent = '‚ö†Ô∏è No disponible';
        }
        
        try {
            const permissions = await navigator.permissions.query({ name: 'microphone' });
            actualizarEstadoPermiso('mic', permissions.state);
            
            permissions.addEventListener('change', () => {
                actualizarEstadoPermiso('mic', permissions.state);
            });
        } catch (e) {
            document.getElementById('mic-status').textContent = '‚ö†Ô∏è No disponible';
        }

        try {
            const permissions = await navigator.permissions.query({ name: 'geolocation' });
            actualizarEstadoPermiso('location', permissions.state);
            
            permissions.addEventListener('change', () => {
                actualizarEstadoPermiso('location', permissions.state);
            });
        } catch (e) {
            document.getElementById('location-status').textContent = '‚ö†Ô∏è No disponible';
        }
    }

    function actualizarEstadoPermiso(tipo, estado) {
        const statusElement = document.getElementById(`${tipo}-status`);
        const btnElement = document.getElementById(`btn-permiso-${tipo}`);
        
        statusElement.classList.remove('status-granted', 'status-denied', 'status-prompt');
        btnElement.classList.remove('granted', 'denied');
        
        if (estado === 'granted') {
            statusElement.textContent = '‚úÖ Concedido';
            statusElement.classList.add('status-granted');
            btnElement.textContent = '‚úì Activo';
            btnElement.classList.add('granted');
            btnElement.disabled = true;
            
            if (tipo === 'location') {
                locationPermissionGranted = true;
            }
        } else if (estado === 'denied') {
            statusElement.textContent = '‚ùå Denegado';
            statusElement.classList.add('status-denied');
            btnElement.textContent = 'Denegado';
            btnElement.classList.add('denied');
            btnElement.disabled = true;
            
            if (tipo === 'location') {
                locationPermissionGranted = false;
            }
        } else {
            statusElement.textContent = '‚ö†Ô∏è No concedido';
            statusElement.classList.add('status-prompt');
            btnElement.textContent = 'Activar';
            btnElement.disabled = false;
        }
    }

    window.solicitarPermisoNotificaciones = function() {
        if ('Notification' in window) {
            Notification.requestPermission().then(permission => {
                verificarEstadosPermisos();
                
                if (permission === 'granted') {
                    alert('‚úÖ Notificaciones activadas correctamente');
                    try {
                        notificationSound.currentTime = 0;
                        notificationSound.play().catch(e => console.log("Error:", e));
                        
                        new Notification('üîî ¬°Notificaciones Activas!', {
                            body: 'Recibir√°s alertas de nuevos mensajes',
                            icon: 'https://i.ibb.co/hJCtmHsf/1761849436845.png'
                        });
                    } catch (e) {
                        console.log("Error:", e);
                    }
                } else {
                    alert('‚ùå Permiso denegado. Act√≠valo desde la configuraci√≥n del navegador.');
                }
            });
        }
    }

    window.solicitarPermisoCamara = async function() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            stream.getTracks().forEach(track => track.stop());
            alert('‚úÖ Permiso de c√°mara concedido');
            verificarEstadosPermisos();
        } catch (error) {
            if (error.name === 'NotAllowedError') {
                alert('‚ùå Permiso denegado. Act√≠valo desde la configuraci√≥n del navegador.');
            } else {
                alert('‚ö†Ô∏è Error al acceder a la c√°mara: ' + error.message);
            }
            verificarEstadosPermisos();
        }
    }

    window.solicitarPermisoMicrofono = async function() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            stream.getTracks().forEach(track => track.stop());
            alert('‚úÖ Permiso de micr√≥fono concedido');
            verificarEstadosPermisos();
        } catch (error) {
            if (error.name === 'NotAllowedError') {
                alert('‚ùå Permiso denegado. Act√≠valo desde la configuraci√≥n del navegador.');
            } else {
                alert('‚ö†Ô∏è Error al acceder al micr√≥fono: ' + error.message);
            }
            verificarEstadosPermisos();
        }
    }

    window.solicitarPermisoUbicacion = function() {
        if (!navigator.geolocation) {
            alert('‚ö†Ô∏è Tu navegador no soporta geolocalizaci√≥n');
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                locationPermissionGranted = true;
                alert('‚úÖ Permiso de ubicaci√≥n concedido\n\n' +
                      'El GPS del cliente se activar√° autom√°ticamente y enviar√° tu ubicaci√≥n a Firebase cada 5 segundos.\n\n' +
                      'Esto permite que el repartidor vea tu ubicaci√≥n en tiempo real.');
                verificarEstadosPermisos();
                
                if (!isClienteLocationActive) {
                    iniciarEnvioUbicacionCliente();
                }
            },
            (error) => {
                if (error.code === error.PERMISSION_DENIED) {
                    alert('‚ùå Permiso denegado. Act√≠valo desde la configuraci√≥n del navegador.');
                } else {
                    alert('‚ö†Ô∏è Error al obtener ubicaci√≥n: ' + error.message);
                }
                verificarEstadosPermisos();
            }
        );
    }

    window.addEventListener('load', () => {
        setTimeout(verificarEstadosPermisos, 1000);
    });

    // ======================================================================
    // === LOG DE INICIALIZACI√ìN ===
    // ======================================================================
    
    console.log('‚úÖ Sistema del cliente inicializado v2.4.0 - Routing Fix');
    console.log('üìç Env√≠o autom√°tico de ubicaci√≥n del cliente: HABILITADO');
    console.log('üó∫Ô∏è Compatible con seguimiento en tiempo real del repartidor');
    console.log('üîÑ Ubicaci√≥n del cliente se env√≠a a Firebase cada 5 segundos');
    console.log('üêõ Sistema de debugging mejorado con logs detallados');
    console.log('üõ£Ô∏è Sistema de routing corregido con validaciones robustas');
  </script>
  <script type="module">
    import { 
        initializeApp 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    
    import { 
        getDatabase, 
        ref, 
        onChildAdded, 
        push, 
        set, 
        onValue, 
        get, 
        query, 
        orderByChild, 
        equalTo,
        off,
        remove,
        update
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    
    import { 
        getAuth, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword, 
        signOut, 
        onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"; 
    
    import { 
        getStorage, 
        ref as storageRef, 
        uploadBytesResumable, 
        getDownloadURL 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAZX7Q5B29Xti4YtV9wXuiREVdkgcclv9U",
      authDomain: "domicilios-1cd74.firebaseapp.com",
      databaseURL: "https://domicilios-1cd74-default-rtdb.firebaseio.com", 
      projectId: "domicilios-1cd74",
      storageBucket: "domicilios-1cd74.firebasestorage.app",
      messagingSenderId: "771819437001", 
      appId: "1:771819437001:web:b9c8f5e4d3a2c1b0a1b2c3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app); 
    const storage = getStorage(app); 

    window.db = db;
    window.push = push;
    window.ref = ref;
    window.set = set;
    window.remove = remove;
    window.update = update;
    window.storage = storage;
    window.storageRef = storageRef;
    window.uploadBytesResumable = uploadBytesResumable;
    window.getDownloadURL = getDownloadURL;
    window.get = get;
    window.query = query;
    window.orderByChild = orderByChild;
    window.equalTo = equalTo;
    window.onValue = onValue;
    window.off = off;

    const chatBox = document.getElementById("chat-box");
    const tabServicio = document.getElementById("tab-servicio");
    const bloqueoAprobacion = document.getElementById("bloqueo-aprobacion");
    const emailInput = document.getElementById("email-input");
    const passwordInput = document.getElementById("password-input");
    const statusDiv = document.getElementById("auth-status");
    const inputChat = document.getElementById("inputChat");
    const btnEnviarMensaje = document.getElementById("btnEnviarMensaje");

    window.USER_ROLE = "Cliente";
    
    function limpiarInputs() {
        emailInput.value = '';
        passwordInput.value = '';
        statusDiv.textContent = '';
    }

    window.registrarConCorreo = function() {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        if (!email || password.length < 6) {
            statusDiv.textContent = "Correo inv√°lido o Contrase√±a debe tener al menos 6 caracteres.";
            return;
        }
        
        statusDiv.textContent = "Registrando usuario...";

        createUserWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
                statusDiv.textContent = "‚úÖ Registro exitoso. Completa tus datos.";
            })
            .catch((error) => {
                let errorMessage;
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "El correo ya est√° registrado. Intenta Iniciar Sesi√≥n.";
                } else {
                    errorMessage = "Error al registrar: " + error.message;
                }
                statusDiv.textContent = errorMessage;
                console.error("Error de Registro:", error);
            });
    }

    window.iniciarSesionConCorreo = function() {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        if (!email || !password) {
            statusDiv.textContent = "Por favor, ingresa correo y contrase√±a.";
            return;
        }
        
        statusDiv.textContent = "Iniciando sesi√≥n...";

        signInWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
                statusDiv.textContent = "‚úÖ Sesi√≥n iniciada.";
            })
            .catch((error) => {
                let errorMessage;
                if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Correo o contrase√±a incorrectos.";
                } else {
                    errorMessage = "Error al iniciar sesi√≥n: " + error.message;
                }
                statusDiv.textContent = errorMessage;
                console.error("Error de Inicio de Sesi√≥n:", error);
            });
    }

    window.signOutUser = function() {
        if (window.activePedidoListener) {
            off(ref(db, `pedidos_pendientes/${window.activePedidoID}`), 'value', window.activePedidoListener);
            window.activePedidoListener = null;
            window.activePedidoID = null;
        }
        
        detenerSeguimientoUbicacion();
        detenerEnvioUbicacionCliente();
        
        off(ref(db, `chats/${window.currentUserID}`));
        
        signOut(auth).then(() => {
            window.currentUserID = null;
            window.currentAuthUser = null;
            window.USER_NAME = null; 
            localStorage.removeItem("usuarioDomicilios"); 
            limpiarInputs();
            window.mostrarVista('vista-inicio');
            console.log('üö™ Sesi√≥n cerrada - GPS del cliente detenido');
        }).catch((error) => {
            console.error("Error al cerrar sesi√≥n:", error);
        });
    }

    onAuthStateChanged(auth, (user) => {
      setTimeout(() => {
          if (typeof hideSplashScreen === 'function') {
    hideSplashScreen();
}
      }, 2000);
      
      if (user) {
        window.currentAuthUser = user;
        window.currentUserID = window.getClientID(user.uid);
        
        get(ref(db, `usuarios/${window.currentUserID}`)) 
          .then(async (snapshot) => {
            if (snapshot.exists() && snapshot.val().direccion && snapshot.val().tel1) {
              const userData = snapshot.val();
              userData.uid = user.uid;
              
              window.mostrarPerfil(userData); 
              
            } else {
              const existingData = snapshot.exists() ? snapshot.val() : {};
              document.getElementById("nombreUsuario").value = existingData.nombre || "";
              document.getElementById("correoUsuario").value = user.email || ""; 
              document.getElementById("telefono1Usuario").value = existingData.tel1 || ""; 
              document.getElementById("telefono2Usuario").value = existingData.tel2 || "";
              document.getElementById("direccionUsuario").value = existingData.direccion || "";

              window.mostrarVista('vista-registro-complemento');
            }
            hideSplashScreen();
          })
          .catch((error) => {
            console.error("Error al leer datos de Firebase DB:", error);
            alert("Error al intentar cargar su perfil.");
            hideSplashScreen();
          });
      } else {
        window.mostrarVista('vista-inicio');
        hideSplashScreen();
      }
    });

    window.guardarUsuarioEnFirebase = function() {
        const authUser = window.currentAuthUser; 

        if (!authUser) {
             alert("Error: No se encontr√≥ la sesi√≥n de autenticaci√≥n.");
             return;
        }

        const usuarioID = window.getClientID(authUser.uid);
        
        const nombre = document.getElementById("nombreUsuario").value.trim();
        const correo = document.getElementById("correoUsuario").value.trim();
        const tel1 = document.getElementById("telefono1Usuario").value.trim(); 
        const tel2 = document.getElementById("telefono2Usuario").value.trim();
        const direccion = document.getElementById("direccionUsuario").value.trim();
        
        if (!tel1 || !direccion) {
            alert("El tel√©fono principal y la direcci√≥n son obligatorios para completar el registro.");
            return;
        }

        const infoFijaUsuario = { 
            uid: authUser.uid, 
            nombre: nombre,
            correo: correo, 
            tel1: tel1, 
            tel2: tel2 || 'N/A', 
            direccion: direccion, 
            foto: 'N/A', 
            ubicacion: {lat: 'N/A', lon: 'N/A'}, 
            estado: "Activo",
            rol: window.USER_ROLE, 
            registro: Date.now(),
            gpsActivo: false
        };
        
        const promesasEscritura = [];

        promesasEscritura.push(set(ref(db, `users/${usuarioID}`), infoFijaUsuario));
        promesasEscritura.push(set(ref(db, `usuarios/${usuarioID}`), infoFijaUsuario));

        Promise.all(promesasEscritura)
            .then(() => {
                localStorage.setItem("usuarioDomicilios", JSON.stringify({...infoFijaUsuario, uid: authUser.uid})); 
                
                window.mostrarPerfil(infoFijaUsuario);
            })
            .catch((error) => {
                alert("Error al guardar en Firebase: " + error.message);
                console.error("Error de Firebase:", error); 
            });
    }

    window.verificarAprobacion = function() {
        if (!window.currentUserID) return;

        onValue(ref(db, `usuarios/${window.currentUserID}`), (snapshot) => {
            if (snapshot.exists()) {
                const userData = snapshot.val();
                const estado = userData.estado || "Activo"; 

                if (window.currentAuthUser) {
                    localStorage.setItem("usuarioDomicilios", JSON.stringify({...userData, uid: window.currentAuthUser.uid}));
                }

                if (estado === "Bloqueado") {
                    tabServicio.disabled = true;
                    document.getElementById("terminos-check").checked = false; 
                    document.getElementById("btnSolicitarChat").disabled = true; 
                    
                    let mensaje = "Tu cuenta est√° **Bloqueada**. No puedes usar el servicio de chat. Contacta al administrador si crees que es un error.";
                    
                    bloqueoAprobacion.innerHTML = mensaje;
                    bloqueoAprobacion.style.display = 'block';
                    
                } else {
                    tabServicio.disabled = false;
                    bloqueoAprobacion.style.display = 'none';
                    
                    habilitarChat(); 
                }
            }
        });
    }
    
    console.log('');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üéâ SISTEMA CLIENTE SERVI ALIADOS - v2.4.0 ROUTING FIX');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('');
    console.log('üìã CARACTER√çSTICAS ACTIVAS:');
    console.log('  ‚úÖ Autenticaci√≥n Firebase con Email/Password');
    console.log('  ‚úÖ Chat en tiempo real con multimedia');
    console.log('  ‚úÖ Notificaciones push con sonido');
    console.log('  ‚úÖ Sistema de permisos con men√∫ hamburguesa');
    console.log('');
    console.log('üÜï GPS AUTOM√ÅTICO DEL CLIENTE:');
    console.log('  üìç Env√≠o autom√°tico a Firebase cada 5 segundos');
    console.log('  üì° Formato: usuarios/{clienteID}/ubicacion {lat, lon}');
    console.log('  üó∫Ô∏è Compatible con lectura del repartidor');
    console.log('');
    console.log('üõ£Ô∏è SISTEMA DE ROUTING MEJORADO:');
    console.log('  ‚úÖ Validaci√≥n de coordenadas antes de trazar');
    console.log('  ‚úÖ C√°lculo de distancia Haversine');
    console.log('  ‚úÖ No traza rutas < 10 metros');
    console.log('  ‚úÖ Manejo robusto de errores OSRM');
    console.log('  ‚úÖ Logs detallados en cada paso');
    console.log('  ‚úÖ Fallback a distancia directa');
    console.log('');
    console.log('üêõ ERRORES CORREGIDOS:');
    console.log('  ‚úÖ Advertencias OSRM demo server (normales)');
    console.log('  ‚úÖ Coordenadas muy cercanas manejadas');
    console.log('  ‚úÖ Validaciones robustas en trazado de rutas');
    console.log('');
    console.log('üì¶ VERSI√ìN: Cliente v2.4.0 - Routing Fix');
    console.log('üïí Fecha: ' + new Date().toLocaleString('es-ES'));
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  </script>
</body>
</html>
